name: Build and Push Docker Images to ECR

on:
  push:
    branches:
      - main
    paths:
      - app/frontend/**
      - app/backend/**
  workflow_dispatch:

jobs:
  # ----------------------------
  # DETECT CHANGES
  # ----------------------------
  detect-changes:
    runs-on: [self-hosted, ci]
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}

    steps:
      - uses: actions/checkout@v4

      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'app/frontend/**'
            backend:
              - 'app/backend/**'

  # ----------------------------
  # BUILD BACKEND
  # ----------------------------
  build-backend:
    needs: detect-changes
    runs-on: [self-hosted, ci]

    outputs:
      image: ${{ steps.output.outputs.image }}

    steps:
      - uses: actions/checkout@v4

      # Always initialize output (CRITICAL)
      - name: Initialize backend image output
        id: output
        run: echo "image=" >> "$GITHUB_OUTPUT"

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v2

      - name: Build & push backend image
        if: |
          github.event_name == 'workflow_dispatch' ||
          needs.detect-changes.outputs.backend == 'true'
        run: |
          IMAGE="${{ secrets.ECR_BACKEND_REPO }}:${{ github.sha }}"
          docker build -t backend:${{ github.sha }} app/backend
          docker tag backend:${{ github.sha }} $IMAGE
          docker push $IMAGE
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

  # ----------------------------
  # BUILD FRONTEND
  # ----------------------------
  build-frontend:
    needs: detect-changes
    runs-on: [self-hosted, ci]

    outputs:
      image: ${{ steps.output.outputs.image }}

    steps:
      - uses: actions/checkout@v4

      # Always initialize output (CRITICAL)
      - name: Initialize frontend image output
        id: output
        run: echo "image=" >> "$GITHUB_OUTPUT"

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v2

      - name: Build & push frontend image
        if: |
          github.event_name == 'workflow_dispatch' ||
          needs.detect-changes.outputs.frontend == 'true'
        run: |
          IMAGE="${{ secrets.ECR_FRONTEND_REPO }}:${{ github.sha }}"
          docker build -t frontend:${{ github.sha }} app/frontend
          docker tag frontend:${{ github.sha }} $IMAGE
          docker push $IMAGE
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

  # ----------------------------
  # DEPLOY
  # ----------------------------
  deploy:
    needs:
      - build-backend
      - build-frontend
    if: |
      github.event_name == 'workflow_dispatch' ||
      needs.build-backend.outputs.image != '' ||
      needs.build-frontend.outputs.image != ''
    uses: ./.github/workflows/deploy-to-k8s.yaml
    with:
      backend_image: ${{ needs.build-backend.outputs.image }}
      frontend_image: ${{ needs.build-frontend.outputs.image }}
