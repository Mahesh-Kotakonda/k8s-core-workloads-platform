name: Build and Push Docker Images to ECR

on:
  push:
    branches:
      - main
    paths:
      - app/frontend/**
      - app/backend/**
  workflow_dispatch:

jobs:
  # ----------------------------
  # DETECT CHANGES (PATH FILTER)
  # ----------------------------
  detect-changes:
    runs-on: [self-hosted, ci]
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'app/frontend/**'
            backend:
              - 'app/backend/**'

      - name: Debug detected paths
        run: |
          echo "Frontend changed: ${{ steps.filter.outputs.frontend }}"
          echo "Backend changed:  ${{ steps.filter.outputs.backend }}"

  # ----------------------------
  # BUILD & PUSH BACKEND IMAGE
  # ----------------------------
  build-backend:
    needs: detect-changes
    if: |
      github.event_name == 'workflow_dispatch' ||
      needs.detect-changes.outputs.backend == 'true'
    runs-on: [self-hosted, ci]

    outputs:
      image: ${{ steps.export.outputs.image }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Configure AWS credentials (IAM role)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push backend image
        run: |
          IMAGE="${{ secrets.ECR_BACKEND_REPO }}:${{ github.sha }}"

          echo "Building backend image: $IMAGE"

          docker build -t backend:${{ github.sha }} app/backend
          docker tag backend:${{ github.sha }} $IMAGE
          docker push $IMAGE

          echo "BACKEND_IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Export backend image output
        id: export
        run: |
          echo "image=$BACKEND_IMAGE" >> "$GITHUB_OUTPUT"
          echo "Backend image output set to: $BACKEND_IMAGE"

  # ----------------------------
  # BUILD & PUSH FRONTEND IMAGE
  # ----------------------------
  build-frontend:
    needs: detect-changes
    if: |
      github.event_name == 'workflow_dispatch' ||
      needs.detect-changes.outputs.frontend == 'true'
    runs-on: [self-hosted, ci]

    outputs:
      image: ${{ steps.export.outputs.image }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Configure AWS credentials (IAM role)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push frontend image
        run: |
          IMAGE="${{ secrets.ECR_FRONTEND_REPO }}:${{ github.sha }}"

          echo "Building frontend image: $IMAGE"

          docker build -t frontend:${{ github.sha }} app/frontend
          docker tag frontend:${{ github.sha }} $IMAGE
          docker push $IMAGE

          echo "FRONTEND_IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Export frontend image output
        id: export
        run: |
          echo "image=$FRONTEND_IMAGE" >> "$GITHUB_OUTPUT"
          echo "Frontend image output set to: $FRONTEND_IMAGE"

  # ----------------------------
  # CALL DEPLOYMENT WORKFLOW
  # ----------------------------
  deploy:
    needs:
      - build-backend
      - build-frontend
    if: |
      github.event_name == 'workflow_dispatch' ||
      needs.build-backend.outputs.image != '' ||
      needs.build-frontend.outputs.image != ''
    uses: ./.github/workflows/deploy-to-k8s.yaml
    with:
      backend_image: ${{ needs.build-backend.outputs.image }}
      frontend_image: ${{ needs.build-frontend.outputs.image }}

