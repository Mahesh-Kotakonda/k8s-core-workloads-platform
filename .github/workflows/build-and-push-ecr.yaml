name: Build and Push Docker Images to ECR

on:
  push:
    branches: [main]
    paths:
      - app/frontend/**
      - app/backend/**
  workflow_dispatch:

jobs:
  # ----------------------------
  # DETECT CHANGES (PUSH ONLY)
  # ----------------------------
  detect-changes:
    if: github.event_name == 'push'
    runs-on: [self-hosted, ci]
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}

    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - app/frontend/**
            backend:
              - app/backend/**

  # ----------------------------
  # BUILD BACKEND (ALWAYS RUNS)
  # ----------------------------
  build-backend:
    runs-on: [self-hosted, ci]
    outputs:
      image: ${{ steps.build.outputs.image }}

    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}
      - uses: aws-actions/amazon-ecr-login@v2

      - name: Build backend image
        id: build
        run: |
          SHOULD_BUILD=false

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SHOULD_BUILD=true
          elif [[ "${{ github.event_name }}" == "push" && "${{ needs.detect-changes.outputs.backend }}" == "true" ]]; then
            SHOULD_BUILD=true
          fi

          if [[ "$SHOULD_BUILD" != "true" ]]; then
            echo "image=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          IMAGE="${{ secrets.ECR_BACKEND_REPO }}:${{ github.sha }}"
          docker build -t backend:${{ github.sha }} app/backend
          docker tag backend:${{ github.sha }} $IMAGE
          docker push $IMAGE
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

  # ----------------------------
  # BUILD FRONTEND (ALWAYS RUNS)
  # ----------------------------
  build-frontend:
    runs-on: [self-hosted, ci]
    outputs:
      image: ${{ steps.build.outputs.image }}

    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}
      - uses: aws-actions/amazon-ecr-login@v2

      - name: Build frontend image
        id: build
        run: |
          SHOULD_BUILD=false

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            SHOULD_BUILD=true
          elif [[ "${{ github.event_name }}" == "push" && "${{ needs.detect-changes.outputs.frontend }}" == "true" ]]; then
            SHOULD_BUILD=true
          fi

          if [[ "$SHOULD_BUILD" != "true" ]]; then
            echo "image=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          IMAGE="${{ secrets.ECR_FRONTEND_REPO }}:${{ github.sha }}"
          docker build -t frontend:${{ github.sha }} app/frontend
          docker tag frontend:${{ github.sha }} $IMAGE
          docker push $IMAGE
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

  # ----------------------------
  # TRIGGER DEPLOYMENT
  # ----------------------------
  trigger-deployment:
    needs: [build-backend, build-frontend]
    runs-on: [self-hosted, ci]

    steps:
      - name: Build deployment payload
        id: payload
        run: |
          images=()

          [[ -n "${{ needs.build-backend.outputs.image }}" ]] && \
            images+=("\"backend_image\":\"${{ needs.build-backend.outputs.image }}\"")

          [[ -n "${{ needs.build-frontend.outputs.image }}" ]] && \
            images+=("\"frontend_image\":\"${{ needs.build-frontend.outputs.image }}\"")

          if [[ ${#images[@]} -eq 0 ]]; then
            echo "has_images=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          joined=$(IFS=,; echo "${images[*]}")
          echo "payload={\"ref\":\"$GITHUB_REF\",$joined}" >> "$GITHUB_OUTPUT"
          echo "has_images=true" >> "$GITHUB_OUTPUT"

      - name: Trigger deployment
        if: steps.payload.outputs.has_images == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: deploy-to-k8s
          client-payload: ${{ steps.payload.outputs.payload }}
