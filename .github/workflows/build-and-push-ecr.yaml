name: Build and Push Docker Images to ECR

on:
  push:
    branches: [main]
    paths:
      - app/frontend/**
      - app/backend/**
  workflow_dispatch:

jobs:
  # ----------------------------
  # DETECT CHANGES
  # ----------------------------
  detect-changes:
    runs-on: [self-hosted, ci]
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}

    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - app/frontend/**
            backend:
              - app/backend/**

  # ----------------------------
  # BUILD BACKEND
  # ----------------------------
  build-backend:
    needs: detect-changes
    runs-on: [self-hosted, ci]

    env:
      EVENT_NAME: ${{ github.event_name }}
      BACKEND_CHANGED: ${{ needs.detect-changes.outputs.backend }}
      IMAGE: ${{ secrets.ECR_BACKEND_REPO }}:${{ github.sha }}

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v2

      - name: Build & push backend image
        shell: bash
        run: |
          if [[ "$EVENT_NAME" == "workflow_dispatch" || "$BACKEND_CHANGED" == "true" ]]; then
            echo "Building backend image: $IMAGE"
            docker build -t backend:${{ github.sha }} app/backend
            docker tag backend:${{ github.sha }} $IMAGE
            docker push $IMAGE
          else
            echo "Backend unchanged — skipping build"
          fi

  # ----------------------------
  # BUILD FRONTEND
  # ----------------------------
  build-frontend:
    needs: detect-changes
    runs-on: [self-hosted, ci]

    env:
      EVENT_NAME: ${{ github.event_name }}
      FRONTEND_CHANGED: ${{ needs.detect-changes.outputs.frontend }}
      IMAGE: ${{ secrets.ECR_FRONTEND_REPO }}:${{ github.sha }}

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v2

      - name: Build & push frontend image
        shell: bash
        run: |
          if [[ "$EVENT_NAME" == "workflow_dispatch" || "$FRONTEND_CHANGED" == "true" ]]; then
            echo "Building frontend image: $IMAGE"
            docker build -t frontend:${{ github.sha }} app/frontend
            docker tag frontend:${{ github.sha }} $IMAGE
            docker push $IMAGE
          else
            echo "Frontend unchanged — skipping build"
          fi

  # ----------------------------
  # TRIGGER DEPLOYMENT (RESULT-BASED)
  # ----------------------------
  trigger-deployment:
    needs: [build-backend, build-frontend]
    runs-on: self-hosted
    if: always()

    steps:
      - name: Debug build results
        run: |
          echo "build-backend result:  ${{ needs.build-backend.result }}"
          echo "build-frontend result: ${{ needs.build-frontend.result }}"

      - name: Build deployment payload
        id: payload
        shell: bash
        env:
          BACKEND_IMAGE:  ${{ secrets.ECR_BACKEND_REPO }}:${{ github.sha }}
          FRONTEND_IMAGE: ${{ secrets.ECR_FRONTEND_REPO }}:${{ github.sha }}
        run: |
          images=()

          [[ "${{ needs.build-backend.result }}" == "success" ]] && \
            images+=("\"backend_image\":\"$BACKEND_IMAGE\"")

          [[ "${{ needs.build-frontend.result }}" == "success" ]] && \
            images+=("\"frontend_image\":\"$FRONTEND_IMAGE\"")

          if [[ ${#images[@]} -eq 0 ]]; then
            echo "No images built — skipping deployment"
            echo "has_images=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          joined=$(IFS=,; echo "${images[*]}")
          echo "payload={\"ref\":\"$GITHUB_REF\",$joined}" >> "$GITHUB_OUTPUT"
          echo "has_images=true" >> "$GITHUB_OUTPUT"

      - name: Trigger deployment workflow
        if: steps.payload.outputs.has_images == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: deploy-to-k8s
          client-payload: ${{ steps.payload.outputs.payload }}
