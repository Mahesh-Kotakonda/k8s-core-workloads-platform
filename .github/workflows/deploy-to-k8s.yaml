name: Deploy to Kubernetes

on:
  repository_dispatch:
    types: [deploy-to-k8s]

jobs:
  deploy:
    runs-on: [self-hosted, deploy]

    env:
      FRONTEND_IMAGE: ${{ github.event.client_payload.frontend_image }}
      BACKEND_IMAGE:  ${{ github.event.client_payload.backend_image }}

    steps:
      - uses: actions/checkout@v4

      # ---------------------------------
      # VALIDATION
      # ---------------------------------
      - name: Pre-deployment validation
        run: |
          echo "Frontend image: $FRONTEND_IMAGE"
          echo "Backend image:  $BACKEND_IMAGE"

          if [ -z "$FRONTEND_IMAGE" ] && [ -z "$BACKEND_IMAGE" ]; then
            echo "❌ No images provided."
            exit 1
          fi

          [[ -n "$FRONTEND_IMAGE" ]] && echo "DEPLOY_FRONTEND=true" >> $GITHUB_ENV
          [[ -n "$BACKEND_IMAGE"  ]] && echo "DEPLOY_BACKEND=true"  >> $GITHUB_ENV

      - name: Set Namespaces
        run: echo "NAMESPACES=dev stage prod" >> $GITHUB_ENV

      # ---------------------------------
      # ENSURE NAMESPACE
      # ---------------------------------
      - name: Ensure Namespaces Exist
        run: |
          for ns in $NAMESPACES; do
            kubectl get ns $ns >/dev/null 2>&1 || kubectl apply -f k8s/namespaces/$ns.yaml
          done

      # ---------------------------------
      # ECR SECRET
      # ---------------------------------
      - name: Create / Update ECR Secret
        run: |
          ECR_PASSWORD=$(aws ecr get-login-password --region us-east-1)

          for ns in $NAMESPACES; do
            kubectl delete secret ecr-secret -n $ns --ignore-not-found
            kubectl create secret docker-registry ecr-secret \
              --namespace $ns \
              --docker-server=349070092739.dkr.ecr.us-east-1.amazonaws.com \
              --docker-username=AWS \
              --docker-password="$ECR_PASSWORD"
          done

      # ---------------------------------
      # DEPLOY PER NAMESPACE
      # ---------------------------------
      - name: Deploy Application
        run: |
          for ns in $NAMESPACES; do

            echo "========== Processing $ns =========="

            if ! kubectl get deployment backend-blue -n $ns >/dev/null 2>&1; then
              echo "First time deployment in $ns"

              # Apply everything
              kubectl apply -f k8s/backend/blue.yaml -n $ns
              kubectl apply -f k8s/backend/green.yaml -n $ns
              kubectl apply -f k8s/backend/service.yaml -n $ns

              kubectl apply -f k8s/frontend/canary-v1.yaml -n $ns
              kubectl apply -f k8s/frontend/canary-v2.yaml -n $ns
              kubectl apply -f k8s/frontend/service-clusterip.yaml -n $ns

              kubectl apply -f k8s/ingress/$ns.yaml -n $ns

              echo "Waiting for pods to be ready..."
              kubectl rollout status deployment/backend-blue -n $ns --timeout=180s
              kubectl rollout status deployment/frontend-v1 -n $ns --timeout=180s

              echo "Waiting for ALB..."
              for i in {1..30}; do
                HOST=$(kubectl get ingress -n $ns \
                  -o jsonpath='{.items[0].status.loadBalancer.ingress[0].hostname}')
                [ -n "$HOST" ] && break
                sleep 10
              done

              echo "ALB Hostname: $HOST"

            else
              echo "Existing deployment detected in $ns"

              # ---------------- BACKEND ----------------
              if [ "$DEPLOY_BACKEND" = "true" ]; then

                ACTIVE_COLOR=$(kubectl get svc backend-service -n $ns \
                  -o jsonpath='{.spec.selector.color}')

                if [ "$ACTIVE_COLOR" = "blue" ]; then
                  TARGET_COLOR="green"
                else
                  TARGET_COLOR="blue"
                fi

                echo "$ns backend: $ACTIVE_COLOR → $TARGET_COLOR"

                kubectl set image deployment/backend-$TARGET_COLOR \
                  backend=$BACKEND_IMAGE -n $ns

                kubectl rollout status deployment/backend-$TARGET_COLOR -n $ns --timeout=180s

                kubectl patch svc backend-service -n $ns \
                  -p "{\"spec\":{\"selector\":{\"app\":\"backend\",\"color\":\"$TARGET_COLOR\"}}}"

                kubectl scale deployment backend-$ACTIVE_COLOR --replicas=0 -n $ns
              fi

              # ---------------- FRONTEND ----------------
              if [ "$DEPLOY_FRONTEND" = "true" ]; then

                echo "$ns frontend canary deployment"

                kubectl set image deployment/frontend-v2 \
                  frontend=$FRONTEND_IMAGE -n $ns

                kubectl rollout status deployment/frontend-v2 -n $ns --timeout=180s

                kubectl scale deployment frontend-v2 --replicas=1 -n $ns
                sleep 20

                kubectl scale deployment frontend-v2 --replicas=2 -n $ns
                kubectl scale deployment frontend-v1 --replicas=2 -n $ns
                sleep 20

                kubectl scale deployment frontend-v2 --replicas=3 -n $ns
                kubectl scale deployment frontend-v1 --replicas=0 -n $ns
              fi

            fi

            echo "Verifying services in $ns"
            kubectl get pods -n $ns
            kubectl get svc -n $ns
            kubectl get ingress -n $ns

          done
