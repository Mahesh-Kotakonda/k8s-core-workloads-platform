name: Deploy to Kubernetes

on:
  # 1ï¸âƒ£ Manual execution
  workflow_dispatch:
    inputs:
      frontend_image:
        description: "Frontend image URI (optional)"
        required: false
        type: string
      backend_image:
        description: "Backend image URI (optional)"
        required: false
        type: string

  # 2ï¸âƒ£ Automatic execution from CI
  workflow_call:
    inputs:
      frontend_image:
        required: false
        type: string
      backend_image:
        required: false
        type: string

jobs:
  deploy:
    name: Kubernetes Deployment
    runs-on: [self-hosted, deploy]

    # ðŸ”‘ CRITICAL FIX â€” support BOTH triggers
    env:
      FRONTEND_IMAGE: ${{ inputs.frontend_image || github.event.inputs.frontend_image }}
      BACKEND_IMAGE:  ${{ inputs.backend_image  || github.event.inputs.backend_image }}

    steps:
      # ----------------------------
      # PRE-DEPLOYMENT STAGE
      # ----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify kubectl access
        run: |
          kubectl version --client
          kubectl get namespaces

      - name: Pre-deployment check
        run: |
          echo "Frontend image: $FRONTEND_IMAGE"
          echo "Backend image:  $BACKEND_IMAGE"

          if [ -z "$FRONTEND_IMAGE" ] && [ -z "$BACKEND_IMAGE" ]; then
            echo "âŒ No images provided. Exiting."
            exit 1
          fi

          if [ -n "$FRONTEND_IMAGE" ]; then
            echo "DEPLOY_FRONTEND=true" >> "$GITHUB_ENV"
          fi

          if [ -n "$BACKEND_IMAGE" ]; then
            echo "DEPLOY_BACKEND=true" >> "$GITHUB_ENV"
          fi

      # # ----------------------------
      # # FRONTEND DEPLOYMENT (CANARY)
      # # ----------------------------
      # - name: Deploy Frontend (Canary v2)
      #   if: env.DEPLOY_FRONTEND == 'true'
      #   run: |
      #     echo "ðŸš€ Deploying frontend canary image: $FRONTEND_IMAGE"

      #     kubectl set image deployment/frontend-v2 \
      #       frontend=$FRONTEND_IMAGE \
      #       -n dev

      #     kubectl rollout status deployment/frontend-v2 -n dev

      # # ----------------------------
      # # BACKEND DEPLOYMENT (BLUE-GREEN)
      # # ----------------------------
      # - name: Deploy Backend (Green)
      #   if: env.DEPLOY_BACKEND == 'true'
      #   run: |
      #     echo "ðŸš€ Deploying backend GREEN image: $BACKEND_IMAGE"

      #     kubectl set image deployment/backend-green \
      #       backend=$BACKEND_IMAGE \
      #       -n dev

      #     kubectl rollout status deployment/backend-green -n dev

      # # ----------------------------
      # # TRAFFIC SWITCH (BLUE â†’ GREEN)
      # # ----------------------------
      # - name: Switch Backend Traffic to Green
      #   if: env.DEPLOY_BACKEND == 'true'
      #   run: |
      #     echo "ðŸ”„ Switching backend traffic to GREEN"

      #     kubectl patch service backend-service -n dev \
      #       -p '{"spec":{"selector":{"app":"backend","version":"green"}}}'

      #     kubectl get svc backend-service -n dev -o wide
