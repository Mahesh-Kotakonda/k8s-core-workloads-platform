name: Deploy to Kubernetes

on:
  repository_dispatch:
    types: [deploy-to-k8s]

jobs:
  deploy:
    runs-on: [self-hosted, deploy]

    env:
      FRONTEND_IMAGE: ${{ github.event.client_payload.frontend_image }}
      BACKEND_IMAGE:  ${{ github.event.client_payload.backend_image }}

    steps:
      - uses: actions/checkout@v4

      - name: Pre-deployment check
        run: |
          echo "Frontend image: $FRONTEND_IMAGE"
          echo "Backend image:  $BACKEND_IMAGE"

          if [ -z "$FRONTEND_IMAGE" ] && [ -z "$BACKEND_IMAGE" ]; then
            echo "âŒ No images provided. Exiting."
            exit 1
          fi

          [[ -n "$FRONTEND_IMAGE" ]] && echo "DEPLOY_FRONTEND=true" >> "$GITHUB_ENV"
          [[ -n "$BACKEND_IMAGE"  ]] && echo "DEPLOY_BACKEND=true"  >> "$GITHUB_ENV"

      # # ----------------------------
      # # FRONTEND DEPLOYMENT (CANARY)
      # # ----------------------------
      # - name: Deploy Frontend (Canary v2)
      #   if: env.DEPLOY_FRONTEND == 'true'
      #   run: |
      #     echo "ðŸš€ Deploying frontend canary image: $FRONTEND_IMAGE"

      #     kubectl set image deployment/frontend-v2 \
      #       frontend=$FRONTEND_IMAGE \
      #       -n dev

      #     kubectl rollout status deployment/frontend-v2 -n dev

      # # ----------------------------
      # # BACKEND DEPLOYMENT (BLUE-GREEN)
      # # ----------------------------
      # - name: Deploy Backend (Green)
      #   if: env.DEPLOY_BACKEND == 'true'
      #   run: |
      #     echo "ðŸš€ Deploying backend GREEN image: $BACKEND_IMAGE"

      #     kubectl set image deployment/backend-green \
      #       backend=$BACKEND_IMAGE \
      #       -n dev

      #     kubectl rollout status deployment/backend-green -n dev

      # # ----------------------------
      # # TRAFFIC SWITCH (BLUE â†’ GREEN)
      # # ----------------------------
      # - name: Switch Backend Traffic to Green
      #   if: env.DEPLOY_BACKEND == 'true'
      #   run: |
      #     echo "ðŸ”„ Switching backend traffic to GREEN"

      #     kubectl patch service backend-service -n dev \
      #       -p '{"spec":{"selector":{"app":"backend","version":"green"}}}'

      #     kubectl get svc backend-service -n dev -o wide
